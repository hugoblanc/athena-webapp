<div class="qa-container">
  <!-- Question Form -->
  <div class="question-section" [class.has-conversation]="currentQuestion">
    <div class="header-content" *ngIf="!currentQuestion">
      <h1 class="title">Que voulez-vous savoir ?</h1>
      <p class="subtitle">Je vais chercher la réponse dans 8 ans d'articles vérifiés</p>
    </div>
    <form [formGroup]="questionForm" (ngSubmit)="onSubmit()">
      <div class="input-wrapper">
        <textarea formControlName="question" rows="1" placeholder="Posez votre question..." [disabled]="isStreaming"
          (input)="autoResize($event)" (keydown)="onKeyDown($event)"></textarea>
        <button mat-icon-button type="submit" [disabled]="questionForm.invalid || isStreaming" class="send-button">
          <mat-icon>arrow_upward</mat-icon>
        </button>
      </div>
      <div class="helper-text" *ngIf="questionForm.get('question')?.invalid && questionForm.get('question')?.touched">
        <span *ngIf="questionForm.get('question')?.hasError('required')">La question est requise</span>
        <span *ngIf="questionForm.get('question')?.hasError('minlength')">Minimum 3 caractères</span>
      </div>
    </form>
  </div>

  <!-- Conversation -->
  <div class="conversation" *ngIf="currentQuestion">
    <!-- User Question -->
    <div class="message user-message">
      <div class="message-content">{{ currentQuestion }}</div>
    </div>

    <!-- AI Answer -->
    <div class="message ai-message">
      <div class="message-icon">
        <img src="assets/icon-192.png" alt="Athena" />
      </div>
      <div class="message-content">
        <div class="answer-text" *ngIf="streamedAnswer" (click)="onInlineSourceClick($event)">
          <span [innerHTML]="parseAnswerWithLinks(streamedAnswer)"></span><span class="cursor"
            *ngIf="isStreaming"></span>
        </div>
        <div class="loading-dots" *ngIf="isLoading || (isStreaming && !streamedAnswer)">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Sources Display -->
  <div class="sources-section" *ngIf="sources && sources.length > 0">
    <div class="sources-header">
      <mat-icon>link</mat-icon>
      <span>{{ sources.length }} source{{ sources.length > 1 ? 's' : '' }}</span>
    </div>

    <div class="sources-list">
      <span class="source-item" *ngFor="let source of sources; let i = index" (click)="navigateToContent(source)">
        <span class="source-number">{{ i + 1 }}</span>
        <div class="source-info">
          <div class="source-title">{{ source.title }}</div>
          <div class="source-meta">
            <span class="source-media">{{ source.mediaKey }}</span>
            <span class="source-relevance" *ngIf="source.relevanceScore">
              {{ (source.relevanceScore * 100) | number: '1.0-0' }}%
            </span>
          </div>
        </div>
      </span>
    </div>
  </div>

  <!-- History Section -->
  <mat-expansion-panel class="history-panel" *ngIf="history && history.length > 0">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>history</mat-icon>
        Historique ({{ history.length }})
      </mat-panel-title>
    </mat-expansion-panel-header>

    <div class="history-list">
      <mat-card class="history-item" *ngFor="let item of history" (click)="loadHistoryItem(item)">
        <mat-card-content>
          <p class="history-question">
            <mat-icon>question_mark</mat-icon>
            {{ item.question }}
          </p>
          <p class="history-date">
            {{ item.createdAt | date: 'dd/MM/yyyy HH:mm' }}
          </p>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-expansion-panel>
</div>